{% extends "base.html" %}

{% block content %}
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCJNmTdUlUdLDvYa2wecXcm_IwIr-PTWwo&callback=initMap"></script>
<script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js"></script>
<!--The div element for the map -->
    <div class="container">
        <div class="row">
            <div class="col-8">
                <div id="map"></div>
            </div>
            <div class="col-4">
                <form action="/app" method="get">
                    <input class="form-control mr-sm-2" type="search" placeholder="Enter Zip Code" aria-label="Search" name="zipcode">
                <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Search</button>
            </div>
        </div>
    </div>
    <script>



// Initialize and add the map
function addMarker(lat, lng, text, map, type){
    var position = {lat: lat, lng: lng};
    var blue_icon = { url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png" }
    var red_icon = { url: "http://maps.google.com/mapfiles/ms/icons/red-dot.png" }
    var yellow_icon = { url: "http://maps.google.com/mapfiles/ms/icons/yellow-dot.png" }
    var pink_icon = { url: "http://maps.google.com/mapfiles/ms/icons/pink-dot.png" }
    var purple_icon = { url: "http://maps.google.com/mapfiles/ms/icons/purple-dot.png" }

    switch(type){
      case 0: icon= blue_icon; break;
      case 1: icon= yellow_icon; break;
      case 2: icon= pink_icon; break;
      case 3: icon= purple_icon; break;
      case 4: icon= red_icon; break;
      default: blue_icon;
    }

    var marker = new google.maps.Marker({position: position, map: map, title: text, icon: icon});

    // var infowindow = new google.maps.InfoWindow({content: text});
    // google.maps.event.addListener(marker, 'click', function() {infowindow.open(map,marker);});

    return marker
  }

function initMap(){
  $.getJSON('/data/zipcode_50000.json', function(data){

    {% if zipcode %}
      var default_zip_code = {{ zipcode }}
    {% else %}
      var default_zip_code = 10001
    {% endif %}

    {% if zipcode %}
      var threshold = {{ threshold }}
    {% else %}
      var threshold = 1000
    {% endif %}

    {% if zoom_level %}
      var zoom_level = {{ zoom_level }}
    {% else %}
      var zoom_level = 4
    {% endif %}
      var zip_code_item = data.items.find(function(item){
        return parseFloat(item.zip_code) == default_zip_code
      })

      var center_position = {lat: 42.42018, lng: -72.10615};

      if (zip_code_item) {
        center_position = {lat: parseFloat(zip_code_item.lat), lng: parseFloat(zip_code_item.lng)}
      }

      // The map, centered at zipcode entered
      var map = new google.maps.Map(
          document.getElementById('map'), {zoom: zoom_level, center: center_position});

      var markers = []


      data.items.forEach(function(info){
          var lat = parseFloat(info.lat)
          var lng = parseFloat(info.lng)
          var county = info.county_name
          var state = info.state
          var zip_code = info.zip_code
          var hcp_count = info.hcp_count
          var hco_count = info.hco_count
          var score = info.score

          if(hcp_count > threshold){
            type = Math.floor(score / 20)
            marker = addMarker(lat, lng, county + " " + state + ", " + zip_code + " Providers: " + hcp_count + " Hospitals: " + hco_count + " Score: " + score, map, type)
            google.maps.event.addListener(marker, 'click', function() {

              url="/app/zipcode/" + zip_code
              window.open(url, '_blank');
            });

            markers.push(marker)
          }
        })


    var markerCluster = new MarkerClusterer(map, markers,
            {imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m'});
    }
  });
}

  </script>
{% endblock %}